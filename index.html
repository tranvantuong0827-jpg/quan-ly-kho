<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no text-center">
    <title>Kho B·∫£o M·∫≠t - T∆∞·ªùng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-custom { animation: pulse 1s infinite; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div id="login-screen" class="max-w-md mx-auto p-6 pt-20">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl text-center space-y-6 border border-white">
            <div class="text-6xl mb-2">üîì</div>
            <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tight">ƒêƒÉng Nh·∫≠p Kho</h2>
            <div class="space-y-4 text-left">
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1 ml-2 uppercase">M√£ nh√¢n vi√™n</label>
                    <input id="userId" type="text" placeholder="V√≠ d·ª•: nv01" class="w-full border-0 bg-slate-100 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-bold">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 mb-1 ml-2 uppercase">M·∫≠t kh·∫©u</label>
                    <input id="userPw" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full border-0 bg-slate-100 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-bold">
                </div>
                <button onclick="login()" id="btnLogin" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-lg hover:bg-blue-700 active:scale-95 transition-all uppercase mt-4">V√†o H·ªá Th·ªëng</button>
            </div>
        </div>
    </div>

    <div id="main-screen" class="hidden max-w-md mx-auto p-4 space-y-4">
        <div class="flex justify-between items-center bg-white p-4 rounded-2xl shadow-sm border border-white text-sm">
            <span id="welcomeMsg" class="font-bold text-blue-700 italic text-center">Ch√†o b·∫°n!</span>
            <button onclick="location.reload()" class="bg-red-50 px-3 py-1 rounded-full text-red-500 font-bold uppercase text-[10px]">Tho√°t</button>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-xl space-y-4 border border-white">
            <h1 class="text-xl font-black text-center text-slate-800 uppercase italic">Qu·∫£n L√Ω Giao D·ªãch</h1>
            <div>
                <input id="pName" list="product-list" type="text" placeholder="T√™n s·∫£n ph·∫©m..." class="w-full bg-slate-50 p-4 rounded-2xl outline-none border-0 focus:ring-2 focus:ring-blue-500 font-medium text-lg">
                <datalist id="product-list"></datalist>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <input id="pQty" type="number" placeholder="S·ªë l∆∞·ª£ng" class="w-full bg-slate-50 p-4 rounded-2xl outline-none border-0 text-center font-black text-xl">
                <select id="pType" class="w-full bg-slate-50 p-4 rounded-2xl outline-none border-0 font-bold text-blue-600 text-center uppercase">
                    <option value="Nh·∫≠p">‚ûï NH·∫¨P</option>
                    <option value="Xu·∫•t">‚ûñ XU·∫§T</option>
                    <option value="Hao h·ª•t">‚ö†Ô∏è HAO H·ª§T</option>
                </select>
            </div>
            <button onclick="saveData()" id="btnSave" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-lg active:scale-95 transition-all text-xl uppercase">L∆∞u D·ªØ Li·ªáu</button>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-white">
            <div class="flex justify-between items-center mb-4 font-black text-blue-800 italic text-lg uppercase tracking-tight">
                <span>T·ªìn Kho Th·ª±c T·∫ø</span>
                <button onclick="fetchData()" class="text-blue-500 font-bold p-2 bg-blue-50 rounded-full">üîÑ</button>
            </div>

            <div class="relative mb-6">
                <input type="text" id="searchInput" onkeyup="filterStock()" placeholder="üîç T√¨m nhanh s·∫£n ph·∫©m..." class="w-full bg-slate-100 p-4 rounded-2xl outline-none border-0 focus:ring-2 focus:ring-blue-400 text-sm font-medium">
            </div>
            
            <div id="inventoryList" class="space-y-4 divide-y divide-slate-50 min-h-[100px]">
                <div class="text-center py-5 text-slate-400 text-sm italic">ƒêang t·∫£i d·ªØ li·ªáu...</div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx99f63pC8wwTKvMyEFcfEjoDw6EtJnSOtBIm7-Wn05xKxf7mIU0GP0c8tJd-FKuGOD/exec";
        let currentUser = "";
        let fullStockData = [];

        async function login() {
            const id = document.getElementById('userId').value.trim();
            const pw = document.getElementById('userPw').value.trim();
            const btn = document.getElementById('btnLogin');
            if(!id || !pw) return alert("Nh·∫≠p ƒë·ªß ID v√† Pass!");
            btn.innerText = "‚åõ ƒêANG KI·ªÇM TRA...";
            try {
                const res = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "login", id: id, pw: pw }) });
                const result = await res.json();
                if (result.status === "success") {
                    currentUser = result.name;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-screen').classList.remove('hidden');
                    document.getElementById('welcomeMsg').innerText = "Ch√†o: " + currentUser;
                    fetchData();
                } else { alert("Sai ID ho·∫∑c m·∫≠t kh·∫©u!"); btn.innerText = "V√ÄO H·ªÜ TH·ªêNG"; }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); btn.innerText = "TH·ª¨ L·∫†I"; }
        }

        async function saveData() {
            const name = document.getElementById('pName').value.trim();
            const qty = parseFloat(document.getElementById('pQty').value);
            const type = document.getElementById('pType').value;
            const btn = document.getElementById('btnSave');

            if (!name || isNaN(qty)) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß!");

            btn.innerText = "‚åõ ƒêANG G·ª¨I...";
            btn.disabled = true;

            try {
                const response = await fetch(SCRIPT_URL, { 
                    method: "POST", 
                    body: JSON.stringify({ name, qty, type, user: currentUser }) 
                });
                
                // TH√îNG B√ÅO KHI L∆ØU TH√ÄNH C√îNG
                alert("‚úÖ C·∫¨P NH·∫¨T TH√ÄNH C√îNG!\n\nüîπ S·∫£n ph·∫©m: " + name + "\nüîπ Lo·∫°i h√¨nh: " + type + "\nüîπ S·ªë l∆∞·ª£ng: " + qty);
                
                document.getElementById('pQty').value = "";
                // N·∫øu mu·ªën x√≥a lu√¥n t√™n s·∫£n ph·∫©m sau khi l∆∞u th√¨ b·ªè comment d√≤ng d∆∞·ªõi:
                // document.getElementById('pName').value = "";
                
                fetchData();
            } catch (e) { 
                alert("‚ùå L·ªñI: Kh√¥ng th·ªÉ l∆∞u d·ªØ li·ªáu!"); 
            } finally {
                btn.innerText = "L∆ØU D·ªÆ LI·ªÜU";
                btn.disabled = false;
            }
        }

        async function fetchData() {
            const listDiv = document.getElementById('inventoryList');
            const dataList = document.getElementById('product-list');
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                let stock = {};
                data.forEach(row => {
                    const n = row[1], t = row[2], q = Number(row[3]);
                    if (!stock[n]) stock[n] = 0;
                    (t === "Nh·∫≠p") ? stock[n] += q : stock[n] -= q;
                });
                
                fullStockData = [];
                dataList.innerHTML = "";
                for (let item in stock) {
                    fullStockData.push({ name: item, count: stock[item] });
                    dataList.innerHTML += '<option value="' + item + '">';
                }
                renderList(fullStockData);
            } catch (e) { listDiv.innerHTML = "L·ªói load d·ªØ li·ªáu."; }
        }

        function renderList(items) {
            const listDiv = document.getElementById('inventoryList');
            listDiv.innerHTML = "";
            if(items.length === 0) {
                listDiv.innerHTML = '<div class="text-center py-5 text-slate-400 text-sm italic text-center">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†y</div>';
                return;
            }
            items.forEach(item => {
                const isLow = item.count <= 10;
                const color = isLow ? 'text-red-600' : 'text-emerald-600';
                const warn = isLow ? ' <span class="text-[9px] bg-red-600 text-white px-2 py-0.5 rounded animate-pulse-custom uppercase">S·∫Øp h·∫øt</span>' : '';
                listDiv.innerHTML += '<div class="flex justify-between items-center pt-4 pb-2 border-b border-slate-50">' +
                    '<div><div class="font-bold text-slate-700 uppercase">' + item.name + '</div>' + warn + '</div>' +
                    '<span class="text-xl font-black ' + color + '">' + item.count.toLocaleString() + '</span></div>';
            });
        }

        function filterStock() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const filtered = fullStockData.filter(item => 
                item.name.toLowerCase().includes(keyword)
            );
            renderList(filtered);
        }
    </script>
</body>
</html>
