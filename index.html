<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kho & Doanh Thu - T∆∞·ªùng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-custom { animation: pulse 1s infinite; }
        body { font-family: -apple-system, sans-serif; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen p-4">

    <div id="login-screen" class="max-w-md mx-auto mt-10 bg-white p-8 rounded-[2.5rem] shadow-2xl border border-white">
        <h2 class="text-2xl font-black text-center text-blue-800 mb-6 uppercase italic">ƒêƒÉng Nh·∫≠p H·ªá Th·ªëng</h2>
        <div class="space-y-4">
            <input id="userId" type="text" placeholder="M√£ nh√¢n vi√™n" class="w-full bg-slate-50 p-4 rounded-2xl border-0 outline-none focus:ring-2 focus:ring-blue-500 font-bold">
            <input id="userPw" type="password" placeholder="M·∫≠t kh·∫©u" class="w-full bg-slate-50 p-4 rounded-2xl border-0 outline-none focus:ring-2 focus:ring-blue-500 font-bold">
            <button onclick="login()" id="btnLogin" class="w-full bg-blue-600 text-white font-black py-4 rounded-2xl shadow-lg uppercase active:scale-95 transition-all">V√†o H·ªá Th·ªëng</button>
        </div>
    </div>

    <div id="main-screen" class="hidden max-w-md mx-auto space-y-4">
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-gradient-to-br from-blue-600 to-blue-800 p-4 rounded-3xl text-white shadow-lg">
                <p class="text-[10px] font-bold uppercase opacity-80">H√¥m nay</p>
                <p id="statDay" class="text-xl font-black italic">0ƒë</p>
            </div>
            <div class="bg-gradient-to-br from-emerald-600 to-emerald-800 p-4 rounded-3xl text-white shadow-lg">
                <p class="text-[10px] font-bold uppercase opacity-80">Th√°ng n√†y</p>
                <p id="statMonth" class="text-xl font-black italic">0ƒë</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-xl space-y-4 border border-white">
            <div class="flex justify-between items-center text-xs font-bold px-2">
                <span id="welcomeMsg" class="text-blue-600 italic">Ch√†o nh√¢n s·ª±!</span>
                <button onclick="location.reload()" class="text-red-500 uppercase">Tho√°t</button>
            </div>

            <input id="pName" list="product-list" type="text" placeholder="T√™n s·∫£n ph·∫©m..." class="w-full bg-slate-50 p-4 rounded-2xl outline-none border-0 focus:ring-2 focus:ring-blue-500 font-medium">
            <datalist id="product-list"></datalist>
            
            <div class="grid grid-cols-2 gap-3">
                <input id="pQty" type="number" placeholder="S·ªë l∆∞·ª£ng" class="w-full bg-slate-50 p-4 rounded-2xl outline-none border-0 text-center font-black text-lg">
                <input id="pPrice" type="number" placeholder="Gi√° b√°n" class="w-full bg-slate-50 p-4 rounded-2xl outline-none border-0 text-center font-black text-blue-600 text-lg">
            </div>
            
            <select id="pType" class="w-full bg-slate-50 p-4 rounded-2xl outline-none border-0 font-bold text-slate-600 text-center uppercase">
                <option value="Xu·∫•t">‚ûñ B√°n Ra (Doanh Thu)</option>
                <option value="Nh·∫≠p">‚ûï Nh·∫≠p Kho</option>
                <option value="Hao h·ª•t">‚ö†Ô∏è Hao H·ª•t</option>
            </select>
            <button onclick="saveData()" id="btnSave" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-lg uppercase text-xl active:scale-95 transition-all">L∆∞u Giao D·ªãch</button>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-white">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-slate-800 uppercase italic">T·ªìn Kho</h3>
                <button onclick="fetchData()" class="text-blue-500 text-xl">üîÑ</button>
            </div>
            <input type="text" id="searchInput" onkeyup="filterStock()" placeholder="üîç T√¨m nhanh s·∫£n ph·∫©m..." class="w-full bg-slate-100 p-4 rounded-2xl outline-none border-0 mb-4 text-sm font-medium">
            <div id="inventoryList" class="space-y-3 divide-y divide-slate-50">ƒêang t·∫£i...</div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzn42CyZ5b8uNKQ7I3ql97uFn2IHwTTK0sGnU3-v4j12h8Sd4YqZ-ndfFYm8GyewbNX/exec";
        let currentUser = "";
        let fullStockData = [];

        async function login() {
            const id = document.getElementById('userId').value.trim();
            const pw = document.getElementById('userPw').value.trim();
            const btn = document.getElementById('btnLogin');
            if(!id || !pw) return alert("Nh·∫≠p ƒë·ªß ID v√† Pass!");
            btn.innerText = "‚åõ ƒêANG KI·ªÇM TRA...";
            try {
                const res = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "login", id: id, pw: pw }) });
                const result = await res.json();
                if (result.status === "success") {
                    currentUser = result.name;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-screen').classList.remove('hidden');
                    document.getElementById('welcomeMsg').innerText = "NV: " + currentUser;
                    fetchData();
                } else { alert("Sai ID ho·∫∑c m·∫≠t kh·∫©u!"); btn.innerText = "V√ÄO H·ªÜ TH·ªêNG"; }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); btn.innerText = "TH·ª¨ L·∫†I"; }
        }

        async function saveData() {
            const name = document.getElementById('pName').value.trim();
            const qty = parseFloat(document.getElementById('pQty').value);
            const price = parseFloat(document.getElementById('pPrice').value) || 0;
            const type = document.getElementById('pType').value;
            const btn = document.getElementById('btnSave');

            if (!name || isNaN(qty)) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß!");
            btn.innerText = "‚åõ ƒêANG G·ª¨I..."; btn.disabled = true;

            try {
                await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ name, qty, price, type, user: currentUser }) });
                alert("‚úÖ TH√ÄNH C√îNG!\nƒê√£ c·∫≠p nh·∫≠t: " + name + "\nS·ªë l∆∞·ª£ng: " + qty + "\nT·ªïng: " + (qty*price).toLocaleString() + "ƒë");
                document.getElementById('pQty').value = "";
                document.getElementById('pPrice').value = "";
                fetchData();
            } catch (e) { alert("L·ªói!"); }
            finally { btn.innerText = "L∆ØU GIAO D·ªäCH"; btn.disabled = false; }
        }

        async function fetchData() {
            const listDiv = document.getElementById('inventoryList');
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                let stock = {}, revDay = 0, revMonth = 0;
                const now = new Date();
                const todayStr = now.toLocaleDateString();
                const month = now.getMonth(), year = now.getFullYear();

                data.forEach(row => {
                    const date = new Date(row[0]), n = row[1], t = row[2], q = Number(row[3]), total = Number(row[7]) || 0;
                    if (!stock[n]) stock[n] = 0;
                    (t === "Nh·∫≠p") ? stock[n] += q : stock[n] -= q;
                    if (t === "Xu·∫•t") {
                        if (date.toLocaleDateString() === todayStr) revDay += total;
                        if (date.getMonth() === month && date.getFullYear() === year) revMonth += total;
                    }
                });

                document.getElementById('statDay').innerText = revDay.toLocaleString() + "ƒë";
                document.getElementById('statMonth').innerText = revMonth.toLocaleString() + "ƒë";
                
                fullStockData = Object.keys(stock).map(k => ({ name: k, count: stock[k] }));
                document.getElementById('product-list').innerHTML = Object.keys(stock).map(k => `<option value="${k}">`).join("");
                renderList(fullStockData);
            } catch (e) { listDiv.innerHTML = "L·ªói load d·ªØ li·ªáu."; }
        }

        function renderList(items) {
            const listDiv = document.getElementById('inventoryList');
            listDiv.innerHTML = items.map(i => `
                <div class="flex justify-between items-center py-3 border-b border-slate-50">
                    <span class="font-bold text-slate-700 uppercase text-xs">${i.name} ${i.count <= 10 ? '<span class="bg-red-600 text-white px-2 py-0.5 rounded-md animate-pulse-custom text-[8px] ml-1">H·∫æT</span>' : ''}</span>
                    <span class="font-black text-lg ${i.count <= 10 ? 'text-red-600' : 'text-emerald-600'}">${i.count}</span>
                </div>
            `).join("");
        }

        function filterStock() {
            const kw = document.getElementById('searchInput').value.toLowerCase();
            renderList(fullStockData.filter(i => i.name.toLowerCase().includes(kw)));
        }
    </script>
</body>
</html>
