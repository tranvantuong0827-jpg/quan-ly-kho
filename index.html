<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kho & Doanh Thu - T∆∞·ªùng</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .animate-pulse-custom { animation: pulse 1s infinite; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    </style>
</head>
<body class="bg-slate-100 min-h-screen">

    <div id="login-screen" class="max-w-md mx-auto p-6 pt-20">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl text-center space-y-6 border border-white">
            <div class="text-6xl mb-2">üí∞</div>
            <h2 class="text-2xl font-black text-slate-800 uppercase tracking-tight italic">Kho & Doanh Thu</h2>
            <div class="space-y-4 text-left">
                <input id="userId" type="text" placeholder="M√£ nh√¢n vi√™n" class="w-full border-0 bg-slate-100 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-bold">
                <input id="userPw" type="password" placeholder="M·∫≠t kh·∫©u" class="w-full border-0 bg-slate-100 p-4 rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 font-bold">
                <button onclick="login()" id="btnLogin" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-lg hover:bg-blue-700 active:scale-95 transition-all uppercase">V√†o H·ªá Th·ªëng</button>
            </div>
        </div>
    </div>

    <div id="main-screen" class="hidden max-w-md mx-auto p-4 space-y-4">
        <div class="grid grid-cols-2 gap-3">
            <div class="bg-gradient-to-br from-blue-600 to-blue-700 p-4 rounded-3xl text-white shadow-lg shadow-blue-200">
                <p class="text-[10px] font-bold uppercase opacity-80">H√¥m nay</p>
                <p id="statDay" class="text-lg font-black tracking-tighter">0ƒë</p>
            </div>
            <div class="bg-gradient-to-br from-emerald-600 to-emerald-700 p-4 rounded-3xl text-white shadow-lg shadow-emerald-200">
                <p class="text-[10px] font-bold uppercase opacity-80">Th√°ng n√†y</p>
                <p id="statMonth" class="text-lg font-black tracking-tighter">0ƒë</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-xl space-y-4 border border-white">
            <div class="flex justify-between items-center mb-2 px-2 text-xs font-bold text-blue-600 italic">
                <span id="welcomeMsg">Ch√†o b·∫°n!</span>
                <button onclick="location.reload()" class="text-red-500 underline">Tho√°t</button>
            </div>

            <input id="pName" list="product-list" type="text" placeholder="T√™n s·∫£n ph·∫©m..." class="w-full bg-slate-50 p-4 rounded-2xl outline-none border-0 focus:ring-2 focus:ring-blue-500 font-medium">
            <datalist id="product-list"></datalist>
            
            <div class="grid grid-cols-2 gap-3">
                <input id="pQty" type="number" placeholder="SL" class="w-full bg-slate-50 p-4 rounded-2xl outline-none border-0 text-center font-black text-lg">
                <input id="pPrice" type="number" placeholder="Gi√° b√°n" class="w-full bg-slate-50 p-4 rounded-2xl outline-none border-0 text-center font-black text-blue-600 text-lg">
            </div>
            
            <select id="pType" class="w-full bg-slate-50 p-4 rounded-2xl outline-none border-0 font-bold text-slate-600 uppercase text-center">
                <option value="Xu·∫•t">‚ûñ B√ÅN RA (T√çNH DT)</option>
                <option value="Nh·∫≠p">‚ûï NH·∫¨P KHO</option>
                <option value="Hao h·ª•t">‚ö†Ô∏è HAO H·ª§T</option>
            </select>
            <button onclick="saveData()" id="btnSave" class="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-lg active:scale-95 transition-all text-xl uppercase">L∆∞u Giao D·ªãch</button>
        </div>

        <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-white">
            <div class="flex justify-between items-center mb-4 font-black text-slate-800 text-lg uppercase italic">
                <span>T·ªìn kho</span>
                <button onclick="fetchData()" class="text-blue-500 font-bold">üîÑ</button>
            </div>
            <input type="text" id="searchInput" onkeyup="filterStock()" placeholder="üîç T√¨m nhanh..." class="w-full bg-slate-100 p-3 rounded-xl text-sm outline-none border-0 mb-4 font-medium">
            <div id="inventoryList" class="space-y-3 divide-y divide-slate-50">ƒêang t·∫£i...</div>
        </div>
    </div>

    <script>
        // LINK SCRIPT M·ªöI C·ª¶A T∆Ø·ªúNG
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx99f63pC8wwTKvMyEFcfEjoDw6EtJnSOtBIm7-Wn05xKxf7mIU0GP0c8tJd-FKuGOD/exec";
        let currentUser = "";
        let fullStockData = [];

        async function login() {
            const id = document.getElementById('userId').value.trim();
            const pw = document.getElementById('userPw').value.trim();
            const btn = document.getElementById('btnLogin');
            if(!id || !pw) return alert("Nh·∫≠p ƒë·ªß ID v√† Pass!");
            btn.innerText = "‚åõ ƒêANG KI·ªÇM TRA...";
            try {
                const res = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "login", id: id, pw: pw }) });
                const result = await res.json();
                if (result.status === "success") {
                    currentUser = result.name;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-screen').classList.remove('hidden');
                    document.getElementById('welcomeMsg').innerText = "NV: " + currentUser;
                    fetchData();
                } else { alert("Sai ID ho·∫∑c m·∫≠t kh·∫©u!"); btn.innerText = "V√ÄO H·ªÜ TH·ªêNG"; }
            } catch (e) { alert("L·ªói k·∫øt n·ªëi!"); btn.innerText = "TH·ª¨ L·∫†I"; }
        }

        async function saveData() {
            const name = document.getElementById('pName').value.trim();
            const qty = parseFloat(document.getElementById('pQty').value);
            const price = parseFloat(document.getElementById('pPrice').value) || 0;
            const type = document.getElementById('pType').value;
            const btn = document.getElementById('btnSave');

            if (!name || isNaN(qty)) return alert("Nh·∫≠p ƒë·ªß t√™n v√† s·ªë l∆∞·ª£ng!");
            btn.innerText = "‚åõ ƒêANG L∆ØU...";
            btn.disabled = true;

            try {
                await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ name, qty, price, type, user: currentUser }) });
                alert("‚úÖ TH√ÄNH C√îNG!\nS·∫£n ph·∫©m: " + name + "\nT·ªïng: " + (qty*price).toLocaleString() + "ƒë");
                document.getElementById('pQty').value = "";
                document.getElementById('pPrice').value = "";
                fetchData();
            } catch (e) { alert("L·ªói g·ª≠i d·ªØ li·ªáu!"); }
            finally { btn.innerText = "L∆ØU GIAO D·ªäCH"; btn.disabled = false; }
        }

        async function fetchData() {
            const listDiv = document.getElementById('inventoryList');
            const dataList = document.getElementById('product-list');
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                
                let stock = {}, revenueDay = 0, revenueMonth = 0;
                const now = new Date();
                const todayStr = now.toLocaleDateString();
                const thisMonth = now.getMonth();
                const thisYear = now.getFullYear();

                data.forEach(row => {
                    const date = new Date(row[0]), n = row[1], t = row[2], q = Number(row[3]), total = Number(row[7]) || 0;
                    if (!stock[n]) stock[n] = 0;
                    (t === "Nh·∫≠p") ? stock[n] += q : stock[n] -= q;
                    
                    if (t === "Xu·∫•t") {
                        if (date.toLocaleDateString() === todayStr) revenueDay += total;
                        if (date.getMonth() === thisMonth && date.getFullYear() === thisYear) revenueMonth += total;
                    }
                });

                document.getElementById('statDay').innerText = revenueDay.toLocaleString() + "ƒë";
                document.getElementById('statMonth').innerText = revenueMonth.toLocaleString() + "ƒë";
                
                fullStockData = [];
                dataList.innerHTML = "";
                for (let item in stock) {
                    fullStockData.push({ name: item, count: stock[item] });
                    dataList.innerHTML += '<option value="' + item + '">';
                }
                renderList(fullStockData);
            } catch (e) { listDiv.innerHTML = "L·ªói load kho."; }
        }

        function renderList(items) {
            const listDiv = document.getElementById('inventoryList');
            listDiv.innerHTML = "";
            items.forEach(item => {
                const isLow = item.count <= 10;
                listDiv.innerHTML += `<div class="flex justify-between items-center py-3 border-b border-slate-50">
                    <span class="font-bold text-slate-700 uppercase text-sm">${item.name} ${isLow ? '<span class="text-[9px] bg-red-600 text-white px-2 py-0.5 rounded animate-pulse-custom ml-1">S·∫ÆP H·∫æT</span>' : ''}</span>
                    <span class="font-black text-lg ${isLow ? 'text-red-600' : 'text-emerald-600'}">${item.count}</span>
                </div>`;
            });
        }

        function filterStock() {
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const filtered = fullStockData.filter(i => i.name.toLowerCase().includes(keyword));
            renderList(filtered);
        }
    </script>
</body>
</html>
