<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kho & Doanh Thu - T∆∞·ªùng</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen font-sans p-4">

    <div id="login-screen" class="max-w-md mx-auto mt-10 bg-white p-8 rounded-3xl shadow-lg border border-gray-200">
        <h2 class="text-2xl font-black text-center text-blue-800 mb-6 uppercase">ƒêƒÇNG NH·∫¨P KHO</h2>
        <input id="userId" type="text" placeholder="M√£ nh√¢n vi√™n" class="w-full bg-gray-50 p-4 rounded-xl mb-3 border focus:ring-2 focus:ring-blue-500 outline-none">
        <input id="userPw" type="password" placeholder="M·∫≠t kh·∫©u" class="w-full bg-gray-50 p-4 rounded-xl mb-6 border focus:ring-2 focus:ring-blue-500 outline-none">
        <button onclick="login()" id="btnLogin" class="w-full bg-blue-600 text-white font-bold py-4 rounded-xl shadow-md active:bg-blue-800 transition-all uppercase">V√†o H·ªá Th·ªëng</button>
    </div>

    <div id="main-screen" class="hidden max-w-md mx-auto space-y-4">
        <div class="grid grid-cols-2 gap-2 text-white">
            <div class="bg-blue-600 p-4 rounded-2xl shadow">
                <p class="text-[10px] uppercase font-bold opacity-80">H√¥m nay</p>
                <p id="statDay" class="text-lg font-black">0ƒë</p>
            </div>
            <div class="bg-emerald-600 p-4 rounded-2xl shadow">
                <p class="text-[10px] uppercase font-bold opacity-80">Th√°ng n√†y</p>
                <p id="statMonth" class="text-lg font-black">0ƒë</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-md space-y-3 border">
            <div class="flex justify-between items-center mb-2">
                <span id="welcomeMsg" class="text-blue-600 font-bold italic text-sm">Ch√†o b·∫°n!</span>
                <button onclick="location.reload()" class="text-red-500 text-xs underline uppercase">Tho√°t</button>
            </div>
            
            <input id="pName" list="product-list" type="text" placeholder="T√™n s·∫£n ph·∫©m..." class="w-full bg-gray-50 p-4 rounded-xl border-0 focus:ring-2 focus:ring-blue-500">
            <datalist id="product-list"></datalist>
            
            <div class="grid grid-cols-2 gap-2">
                <input id="pQty" type="number" placeholder="S·ªë l∆∞·ª£ng" class="w-full bg-gray-50 p-4 rounded-xl text-center font-bold">
                <input id="pPrice" type="number" placeholder="Gi√° ti·ªÅn" class="w-full bg-gray-50 p-4 rounded-xl text-center font-bold text-blue-600">
            </div>

            <select id="pType" class="w-full bg-gray-50 p-4 rounded-xl font-bold text-gray-700 outline-none">
                <option value="Xu·∫•t">B√ÅN RA (T√çNH DT)</option>
                <option value="Nh·∫≠p">NH·∫¨P KHO (+)</option>
                <option value="Hao h·ª•t">HAO H·ª§T (-)</option>
            </select>
            
            <button onclick="saveData()" id="btnSave" class="w-full bg-blue-600 text-white font-black py-4 rounded-xl uppercase shadow-md active:scale-95 transition-all">L∆∞u Giao D·ªãch</button>
        </div>

        <div class="bg-white p-6 rounded-3xl shadow-md border">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-black text-gray-800 uppercase italic">T·ªìn kho hi·ªán t·∫°i</h3>
                <button onclick="fetchData()" class="text-blue-500 text-xl font-bold">üîÑ</button>
            </div>
            <input type="text" id="searchInput" onkeyup="filterStock()" placeholder="üîç T√¨m nhanh..." class="w-full bg-gray-100 p-3 rounded-xl mb-4 outline-none text-sm">
            <div id="inventoryList" class="space-y-2 divide-y">ƒêang t·∫£i...</div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx99f63pC8wwTKvMyEFcfEjoDw6EtJnSOtBIm7-Wn05xKxf7mIU0GP0c8tJd-FKuGOD/exec";
        let currentUser = "";
        let fullStockData = [];

        async function login() {
            const id = document.getElementById('userId').value.trim();
            const pw = document.getElementById('userPw').value.trim();
            const btn = document.getElementById('btnLogin');
            if(!id || !pw) return alert("Nh·∫≠p ƒë·ªß ID v√† Pass!");
            
            btn.innerText = "‚åõ ƒêANG KI·ªÇM TRA...";
            try {
                const res = await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ action: "login", id: id, pw: pw }) });
                const result = await res.json();
                if (result.status === "success") {
                    currentUser = result.name;
                    document.getElementById('login-screen').classList.add('hidden');
                    document.getElementById('main-screen').classList.remove('hidden');
                    document.getElementById('welcomeMsg').innerText = "NV: " + currentUser;
                    fetchData();
                } else { 
                    alert("Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u!"); 
                    btn.innerText = "V√ÄO H·ªÜ TH·ªêNG";
                }
            } catch (e) { 
                alert("L·ªói k·∫øt n·ªëi! H√£y ki·ªÉm tra link Script ho·∫∑c c√†i ƒë·∫∑t 'Anyone' khi Deploy.");
                btn.innerText = "TH·ª¨ L·∫†I";
            }
        }

        async function saveData() {
            const name = document.getElementById('pName').value.trim();
            const qty = parseFloat(document.getElementById('pQty').value);
            const price = parseFloat(document.getElementById('pPrice').value) || 0;
            const type = document.getElementById('pType').value;
            if (!name || isNaN(qty)) return alert("Vui l√≤ng nh·∫≠p ƒë·ªß th√¥ng tin!");

            document.getElementById('btnSave').innerText = "‚åõ ƒêANG G·ª¨I...";
            try {
                await fetch(SCRIPT_URL, { method: "POST", body: JSON.stringify({ name, qty, price, type, user: currentUser }) });
                alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
                document.getElementById('pQty').value = "";
                document.getElementById('pPrice').value = "";
                fetchData();
            } catch (e) { alert("L·ªói g·ª≠i d·ªØ li·ªáu!"); }
            finally { document.getElementById('btnSave').innerText = "L∆ØU GIAO D·ªäCH"; }
        }

        async function fetchData() {
            try {
                const res = await fetch(SCRIPT_URL);
                const data = await res.json();
                let stock = {}, revDay = 0, revMonth = 0;
                const now = new Date();
                const todayStr = now.toLocaleDateString();
                const thisMonth = now.getMonth();
                const thisYear = now.getFullYear();

                data.forEach(row => {
                    const date = new Date(row[0]), n = row[1], t = row[2], q = Number(row[3]), tot = Number(row[7]) || 0;
                    if (!stock[n]) stock[n] = 0;
                    (t === "Nh·∫≠p") ? stock[n] += q : stock[n] -= q;
                    if (t === "Xu·∫•t") {
                        if (date.toLocaleDateString() === todayStr) revDay += tot;
                        if (date.getMonth() === thisMonth && date.getFullYear() === thisYear) revMonth += tot;
                    }
                });

                document.getElementById('statDay').innerText = revDay.toLocaleString() + "ƒë";
                document.getElementById('statMonth').innerText = revMonth.toLocaleString() + "ƒë";
                fullStockData = Object.keys(stock).map(k => ({ name: k, count: stock[k] }));
                
                const dl = document.getElementById('product-list');
                dl.innerHTML = Object.keys(stock).map(k => `<option value="${k}">`).join("");
                renderList(fullStockData);
            } catch (e) { document.getElementById('inventoryList').innerText = "L·ªói load d·ªØ li·ªáu."; }
        }

        function renderList(items) {
            const listDiv = document.getElementById('inventoryList');
            listDiv.innerHTML = items.map(i => `
                <div class="flex justify-between items-center py-3">
                    <span class="font-bold text-gray-700 uppercase text-xs">${i.name}</span>
                    <span class="font-black ${i.count <= 10 ? 'text-red-600' : 'text-emerald-600'}">${i.count}</span>
                </div>
            `).join("");
        }

        function filterStock() {
            const kw = document.getElementById('searchInput').value.toLowerCase();
            renderList(fullStockData.filter(i => i.name.toLowerCase().includes(kw)));
        }
    </script>
</body>
</html>
